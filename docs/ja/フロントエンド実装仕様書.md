# タスバル フロントエンド実装仕様書

> 生成日: 2026-01-18
> 対象: Flutter フロントエンド実装
> アーキテクチャ: Clean Architecture + Redux

---

## 1. アーキテクチャ概要

### 1.1 レイヤー構成

```
src/features/{feature}/
├── domain/                    # ドメイン層（ビジネスロジック）
│   ├── entities/              # エンティティ
│   ├── repositories/          # リポジトリインターフェース
│   └── use_cases/             # ユースケース
│
├── data/                      # データ層（データアクセス）
│   ├── models/                # JSONモデル
│   ├── repositories/          # リポジトリ実装
│   ├── data_sources/
│   │   ├── local/             # ローカルデータソース（SQLite/キャッシュ）
│   │   └── remote/            # リモートデータソース（API）
│   └── demo/                  # デモデータ
│
├── presentation/              # プレゼンテーション層（UI）
│   ├── redux/                 # Redux状態管理
│   │   ├── {feature}_actions.dart
│   │   ├── {feature}_state.dart
│   │   ├── {feature}_reducer.dart
│   │   └── {feature}_thunks.dart
│   ├── screens/               # 画面
│   └── widgets/               # UIコンポーネント
│
└── di/                        # 依存性注入
    └── {feature}_injection.dart
```

### 1.2 データフロー

```
UI Event
    ↓
Thunk (非同期処理)
    ↓
Use Case (ビジネスロジック)
    ↓
Repository (データアクセス)
    ↓
Success/Failure Action
    ↓
Reducer (状態更新)
    ↓
State Change → UI Re-render
```

---

## 2. タスク機能 実装詳細

### 2.1 Task エンティティ

**ファイル**: `domain/entities/task.dart`

```dart
class Task extends Equatable {
  final String id;           // タスクID
  final String title;        // タイトル（必須）
  final String? memo;        // メモ（任意）
  final TaskState state;     // 状態
  final bool isPinned;       // ピン留め
  final DateTime? dueAt;     // 期限
  final List<String> tags;   // タグ
  final DateTime createdAt;  // 作成日時
  final DateTime updatedAt;  // 更新日時
  final DateTime? completedAt; // 完了日時

  // 算出プロパティ
  bool get isCompleted => state == TaskState.Completed;
  bool get isHidden => state == TaskState.Hidden;
  bool get isExpired => state == TaskState.Expired;
  bool get isActive => state == TaskState.Active;
  bool get hasDueDate => dueAt != null;
  bool get isDueSoon; // 24時間以内
  bool get isOverdue; // 期限超過
}
```

### 2.2 TaskState Enum

**ファイル**: `src/enums/task_state.dart`

```dart
enum TaskState {
  Active,    // 通常（未完了）
  Completed, // 完了
  Hidden,    // 非表示
  Expired,   // 期限切れ
}
```

### 2.3 Redux State

**ファイル**: `presentation/redux/task_state.dart`

```dart
class TaskState extends Equatable {
  final List<Task> tasks;        // タスク一覧
  final bool showHidden;         // 非表示タスクを表示
  final bool showExpired;        // 期限切れタスクを表示
  final bool isLoading;          // 取得中フラグ
  final bool isUpdating;         // 操作中フラグ
  final String? errorMessage;    // エラーメッセージ

  // 算出プロパティ（getter）
  List<Task> get visibleTasks;     // フィルタ済みタスク
  List<Task> get activeTasks;      // アクティブタスク
  List<Task> get completedTasks;   // 完了タスク（ピン除外）
  List<Task> get pinnedTasks;      // ピン留めタスク
  List<Task> get unpinnedTasks;    // 非ピンのアクティブタスク
  List<Task> get tasksWithDueDate; // 期限付き（期限順）
  List<Task> get tasksWithoutDueDate; // 期限なし
  List<String> get allTags;        // 全タグ一覧
}
```

### 2.4 Redux Actions

**ファイル**: `presentation/redux/task_actions.dart`

| アクション | 説明 |
|----------|------|
| FetchTasksStartAction | タスク取得開始 |
| FetchTasksSuccessAction | タスク取得成功 |
| FetchTasksFailureAction | タスク取得失敗 |
| CreateTaskStartAction | タスク作成開始 |
| CreateTaskSuccessAction | タスク作成成功 |
| CreateTaskFailureAction | タスク作成失敗 |
| UpdateTaskStartAction | タスク更新開始 |
| UpdateTaskSuccessAction | タスク更新成功 |
| UpdateTaskFailureAction | タスク更新失敗 |
| ToggleTaskCompletionStartAction | 完了切替開始 |
| ToggleTaskCompletionSuccessAction | 完了切替成功 |
| ToggleTaskCompletionFailureAction | 完了切替失敗 |
| ToggleTaskPinStartAction | ピン切替開始 |
| ToggleTaskPinSuccessAction | ピン切替成功 |
| ToggleTaskPinFailureAction | ピン切替失敗 |
| DeleteTaskStartAction | タスク削除開始 |
| DeleteTaskSuccessAction | タスク削除成功 |
| DeleteTaskFailureAction | タスク削除失敗 |
| ToggleShowHiddenAction | 非表示トグル切替 |
| ToggleShowExpiredAction | アーカイブトグル切替 |
| ClearTaskErrorAction | エラークリア |

### 2.5 Use Cases

**ファイル**: `domain/use_cases/`

| ユースケース | 説明 |
|------------|------|
| GetTasksUseCase | タスク一覧取得 |
| CreateTaskUseCase | タスク作成 |
| UpdateTaskUseCase | タスク更新 |
| ToggleTaskCompletionUseCase | 完了切替 |
| ToggleTaskPinUseCase | ピン切替 |
| DeleteTaskUseCase | タスク削除 |

### 2.6 Repository

**ファイル**: `data/repositories/task_repository_impl.dart`

```dart
class TaskRepositoryImpl implements TaskRepository {
  // タスク一覧取得（フィルタ対応）
  Future<Either<Failure, List<Task>>> getTasks({
    bool includeHidden = false,
    bool includeExpired = false,
  });

  // タスク作成
  Future<Either<Failure, Task>> createTask({
    required String title,
    String? memo,
    DateTime? dueAt,
    List<String> tags = const [],
  });

  // タスク更新
  Future<Either<Failure, Task>> updateTask({
    required String id,
    String? title,
    String? memo,
    DateTime? dueAt,
    List<String>? tags,
  });

  // 完了切替
  Future<Either<Failure, Task>> toggleTaskCompletion({
    required String id,
    required bool completed,
  });

  // ピン切替
  Future<Either<Failure, Task>> toggleTaskPin({
    required String id,
    required bool pinned,
  });

  // タスク削除
  Future<Either<Failure, void>> deleteTask(String id);

  // 期限切れタスクをアーカイブ
  Future<Either<Failure, void>> archiveExpiredTasks();

  // サーバー同期
  Future<Either<Failure, void>> syncWithServer();
}
```

---

## 3. UIコンポーネント

### 3.1 Liquid Glass ウィジェット

| ウィジェット | 説明 |
|------------|------|
| LiquidGlassTaskCard | タスクカード |
| LiquidGlassFilterChip | フィルタチップ |
| LiquidGlassTaskSection | セクション見出し |
| LiquidGlassTaskListSection | セクション付きリスト |
| LiquidGlassCreateTaskSheet | タスク作成シート |

### 3.2 フォームウィジェット

| ウィジェット | 説明 |
|------------|------|
| TaskEditForm | タスク編集フォーム |
| TagAutocompleteField | タグ入力（オートコンプリート） |
| DueDatePicker | 期限選択 |

### 3.3 TaskScreen 構成

```
TaskScreen
├── AppBar (日付表示)
├── 表示トグルセクション
│   ├── LiquidGlassFilterChip (非表示)
│   └── LiquidGlassFilterChip (アーカイブ)
├── タスクリスト
│   ├── LiquidGlassTaskListSection (ピン留め)
│   │   └── LiquidGlassTaskCard[]
│   ├── LiquidGlassTaskListSection (期限付き)
│   │   └── LiquidGlassTaskCard[]
│   ├── LiquidGlassTaskListSection (タスク)
│   │   └── LiquidGlassTaskCard[]
│   └── LiquidGlassTaskListSection (完了)
│       └── LiquidGlassTaskCard[]
└── FAB (タスク追加)
```

---

## 4. エラーハンドリング

### 4.1 Failure 型

| 型 | 説明 |
|---|------|
| CacheFailure | キャッシュエラー |
| NetworkFailure | ネットワークエラー |
| ServerFailure | サーバーエラー |
| UnauthorizedFailure | 認証エラー |
| ValidationFailure | バリデーションエラー |

### 4.2 エラーメッセージ方針

- 叱らない
- 急かさない
- 短く伝える

例:
- 「通信が不安定です。もう一度試してください」
- 「タイトルを入力してください」

---

## 5. 依存性注入

**ファイル**: `di/task_injection.dart`

```dart
void configureTasks() {
  // Data Sources
  sl.registerLazySingleton<TaskLocalService>(() => TaskLocalServiceImpl());
  sl.registerLazySingleton<TaskApiService>(() => TaskApiServiceImpl());

  // Repository
  sl.registerLazySingleton<TaskRepository>(
    () => TaskRepositoryImpl(
      localService: sl(),
      apiService: sl(),
    ),
  );

  // Use Cases
  sl.registerFactory(() => GetTasksUseCase(sl()));
  sl.registerFactory(() => CreateTaskUseCase(sl()));
  sl.registerFactory(() => UpdateTaskUseCase(sl()));
  sl.registerFactory(() => ToggleTaskCompletionUseCase(sl()));
  sl.registerFactory(() => ToggleTaskPinUseCase(sl()));
  sl.registerFactory(() => DeleteTaskUseCase(sl()));
}
```

---

## 6. ファイル一覧

### domain/

| ファイル | 説明 |
|---------|------|
| entities/task.dart | Task エンティティ |
| repositories/task_repository.dart | リポジトリインターフェース |
| use_cases/get_tasks_use_case.dart | タスク取得 |
| use_cases/create_task_use_case.dart | タスク作成 |
| use_cases/update_task_use_case.dart | タスク更新 |
| use_cases/toggle_task_completion_use_case.dart | 完了切替 |
| use_cases/toggle_task_pin_use_case.dart | ピン切替 |
| use_cases/delete_task_use_case.dart | タスク削除 |

### data/

| ファイル | 説明 |
|---------|------|
| models/task_model.dart | JSON変換モデル |
| repositories/task_repository_impl.dart | リポジトリ実装 |
| data_sources/local/task_local_service.dart | ローカルデータソース |
| data_sources/remote/task_api_service.dart | APIデータソース |
| demo/demo_tasks.dart | デモデータ |

### presentation/

| ファイル | 説明 |
|---------|------|
| redux/task_actions.dart | Reduxアクション |
| redux/task_state.dart | Redux状態 |
| redux/task_reducer.dart | Reducer |
| redux/task_thunks.dart | Thunks（非同期処理） |
| screens/task_screen.dart | タスク画面 |
| widgets/liquid_glass_task_card.dart | タスクカード |
| widgets/liquid_glass_filter_chip.dart | フィルタチップ |
| widgets/liquid_glass_task_section.dart | セクション |
| widgets/liquid_glass_task_list_section.dart | リストセクション |
| widgets/liquid_glass_create_task_sheet.dart | 作成シート |
| widgets/form/task_edit_form.dart | 編集フォーム |
| widgets/form/tag_autocomplete_field.dart | タグ入力 |

---

## 7. デモモード

開発時は `kDebugMode` で動作を切り替え：

- **デバッグモード**: デモデータを使用、ローカル状態のみ更新
- **リリースモード**: API通信、サーバー同期

```dart
if (kDebugMode) {
  store.dispatch(LoadDemoTasksAction(DemoTasks.visible));
} else {
  store.dispatch(fetchTasksThunk(useCase: useCase));
}
```

---

## 8. TODO

- [ ] タスク作成シートの実装
- [ ] 風船への加算処理の連携
- [ ] オフライン時のキュー処理
- [ ] 期限切れ自動アーカイブのバッチ処理

---

以上
