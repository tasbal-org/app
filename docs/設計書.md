# タスバル 設計書（MVP 最終決定版）

## 1. 概要

タスバルは、タスク管理を「達成の可視化」ではなく、**世界の気配として感じる体験**に変換するアプリである。
数値・ランキング・比較を排除し、背景に漂う風船を通じて「進み」「休み」「誰かと同じ世界にいる」ことを静かに伝える。

---

## 2. 基本思想・原則

* 数値・ランキング・貢献量は表示しない
* 背景風船には文字を出さない
* 風船は操作対象ではなく“空気”として存在する
* 深呼吸は特別扱いしない（同じ世界に在る）
* 比較・所有・評価を生まない

---

## 3. 画面構成（3タブ）

```
[ タスク ] | [ 風船 ] | [ 設定 ]
```

* 初回起動・復帰時は必ず「タスク」タブ
* 全画面で背景風船は共通表示
* 深呼吸は独立画面を持たない

---

## 4. タスク一覧 UI仕様

### 4.1 画面構造

```
┌──────────────────┐
│ Header            │
│  今日の日付       │
│  （状態チップ）   │
├──────────────────┤
│ 表示トグル        │
│ [ 非表示 ] [ ｱｰｶｲﾌﾞ ]
├──────────────────┤
│ 通常タスク一覧    │
│  □ タスクA        │
│  □ タスクB        │
│                  │
│ 完了タスク        │
│  ✓ タスクC        │
├──────────────────┤
│ ＋（FAB）         │
└──────────────────┘
```

### 4.2 表示トグル

| トグル   | 初期  | 内容         |
| ----- | --- | ---------- |
| 非表示   | OFF | 非表示タスクを表示  |
| アーカイブ | OFF | 期限切れタスクを表示 |

### 4.3 タスク状態

| 状態   | 表示          | 加算 |
| ---- | ----------- | -- |
| 通常   | 通常一覧        | ×  |
| 完了   | 完了セクション     | ○  |
| 非表示  | トグルON時のみ    | ×  |
| 期限切れ | アーカイブトグルON時 | ×  |

#### 4.3.1 ピン留め（Pinned Task）

* ピン留めはタスクの表示上の優先度（状態とは独立）
* ピン留めされたタスクは「通常一覧の先頭」に固定表示
* 非表示・期限切れの場合は、基本的にピン表示対象外（表示しない）

※ピン留めは“評価”ではなく、単に「視界に置く」ための機能。

### 4.4 操作（ジェスチャー）

タスク行は、極力「画面遷移なし」で操作できるようにする。

#### 4.4.1 スワイプ操作

* 左スワイプ：アクションボタンを表示

  * [非表示]（hidden）
  * [削除]（delete）

    * 削除は確認ダイアログを出す（誤操作防止）

* 右スワイプ：ピン留め（pin）

  * ピン留めはトグル（ON/OFF）
  * ピン留めされたタスクは一覧上部に固定表示

#### 4.4.2 タップ操作

* タップ：完了切替（チェック）

  * 完了時は画面遷移なし
  * 背景風船が反応（膨らみ/割れ判定）

#### 4.4.3 追加メニュー（任意）

* …（三点）または長押し：

  * 期限設定（ある場合）
  * 編集（タイトル/メモ）

---

## 5. 背景風船 仕様

### 5.1 表示グループ

#### 常時表示（画面外に出ない）

* 共通（グローバル）風船
* ロケーション風船
* 深呼吸風船
* 自分が選択している風船

#### 流動（画面外OK）

* 他ユーザーの公開風船
* ゲリラ風船

### 5.2 共通挙動

* ゆっくり漂う
* 全風船衝突ON（ふわっと反発）
* 進捗に応じて膨らむ（上限あり）
* 割れ演出は控えめ

### 5.3 タップ時リアクション（最小）

* 情報表示なし
* 画面遷移なし
* 少し揺れる、ハイライトが一瞬強まる

---

## 6. 風船仕様（詳細・最終）

本章は、背景風船エンジン実装に必要な**すべての挙動・状態・描画・演出ルール**を定義する。
UI/UX・思想・負荷の観点から、ここに書かれていない挙動は**実装しない**。

---

### 6.1 風船の基本定義

* 風船は**操作対象ではない**（タップ可能だが意味を持たない）
* 文字・数値・名前は背景に表示しない
* 風船は常に背景レイヤに存在する
* 見えるのは「色・大きさ・動き・割れ」のみ

---

### 6.2 風船の種類（balloon_type）

| 種類        | 説明     | 常時表示 | 画面外に出る | 備考          |
| --------- | ------ | ---- | ------ | ----------- |
| global    | 世界共通   | ○    | ×      | 常に1つ以上表示    |
| location  | 国単位    | ○    | ×      | 国未設定時は非表示   |
| breathing | 深呼吸    | ○    | ×      | UTC日次集計で割れる |
| user      | ユーザー作成 | △    | △      | 選択中のみ常時表示   |
| guerrilla | ゲリラ    | ×    | ○      | 期間限定        |

---

### 6.3 表示グループ

#### 常時表示グループ（Pinned）

* global
* location
* breathing
* **選択中の user 風船**

挙動：

* 画面端で反発
* 画面外には出ない

#### 流動グループ（Drifting）

* 未選択の user 風船
* guerrilla 風船

挙動：

* 画面外から出入りする
* 画面外に出たら破棄・再生成

---

### 6.4 物理挙動（共通）

#### 移動

* 上昇速度：-8 ～ -18 px/s
* 横揺れ：-6 ～ +6 px/s
* ゆらぎ周期：4 ～ 7 秒

#### 衝突

* 全風船衝突ON
* 円形簡易衝突判定
* 反発係数：0.7
* 減衰：0.99 / frame
* 空間分割（グリッド）必須

---

### 6.5 サイズ・進捗（膨らみ）

* 基本半径：22 ～ 28px
* 膨らみ最大：+10 ～ +14px
* progress_ratio = current_value / next_threshold
* サイズ反映は線形

※ 深呼吸風船も同じ計算だが、変化は控えめ

---

### 6.6 色・国旗

#### 色

* user 風船：固定12色パレットから1色
* global / breathing：白系
* guerrilla：やや強調色

#### 国旗（location）

* 風船表面に**プリント**として表示
* alpha 0.12 ～ 0.22
* 常時表示（割れ時に一瞬強調してもよい）

---

### 6.7 タグ・束ね表現

#### タグ

* balloon_membership が有効な風船
* タグアイコン12個から選択
* 文字なし・意味なし

#### 束ね

* 選択中風船が2つ以上のとき
* 最大3個まで描画
* 色は各風船の元色

---

### 6.8 割れ（Break）

* current_value >= next_threshold で発生

* 演出は控えめ

  * 破片：10～30
  * 光の波紋：1回
  * 音：なし or 極小

* 深呼吸・ロケーション・ユーザーすべて共通

---

### 6.9 タップ時リアクション（最小）

* 情報表示なし
* 遷移なし
* 軽く揺れる
* ハイライト一瞬強調

---

### 6.10 負荷制御

#### Normal

* 風船数：14
* 衝突：ON
* ブラー：ON

#### Low

* 風船数：10
* 衝突：ON
* ブラー：OFF

切替条件：

* 省電力モード
* fps低下時

---

## 7. 風船タブ（概要）

* 自分の風船

  * 作成（固定12色・タグ12個）
  * 自動参加
* 公開風船

  * 参加／退出
* 選択管理

  * Free：1つ
  * Pro：複数（束＋タグ）

---

## 7. 設定画面（1画面完結）

```
[ 設定 ]

■ ロケーション
  国：未設定 / 日本
  [ 現在地から提案 ]

■ 表示
  描画品質：自動 / Normal / Low
  [ ] 省電力時は自動でLow

■ 深呼吸
  説明テキストのみ

■ その他
  通報
  ヘルプ
  利用規約 / プライバシー
```

---

## 8. 色・タグ

* Free固定パレット：12色
* タグアイコン：12個（意味を持たない抽象シンボル）
* 色・タグは識別や評価を目的としない

---

## 9. データモデル（DBスキーマは別ファイル）

本設計書では、**画面・挙動・体験に必要な概念モデル**のみ定義する。
DBスキーマ（DDL）は別ファイル `tasbal_db_schema.md` にまとめる（後回し）。

### 9.1 概念エンティティ

* ユーザー（User）

  * 国設定（任意）
  * プラン（Free / Pro）

* タスク（Task）

  * 状態：通常 / 完了 / 非表示 / 期限切れ（自動アーカイブ）
  * 期限（任意）

* 風船（Balloon）

  * 種類：global / location / breathing / user / guerrilla
  * 表現：色（user）、国旗プリント（location）、タグアイコン（user）

* 参加（Membership）

  * 風船とユーザーの関係（参加中/退出）

* 選択（Selection）

  * “今関係している”風船の集合（Free=1、Pro=複数）

* 進捗（Progress）

  * 風船が膨らむための値（current / threshold / breakCount）
  * 集計単位：個人 / 国 / グローバル / 深呼吸（日次UTC）

* ゲリラ開催（GuerrillaEvent）

  * 自動生成（1日3〜5回、1〜3時間）
  * 管理者作成（外部から注入可能）

---

## 10. 起動・導線・通知（非押し付け設計）

### 10.1 初回起動

* 初回起動時はタスクタブを表示
* 国設定は必須にしない（未設定でも利用可能）
* 権限要求（位置情報）は初回では行わない

### 10.2 起動時の導線

* JPユーザー（国=JP）の場合、18時以降は「深呼吸」の存在感を**わずかに増やす**

  * 例：深呼吸風船のハイライトをほんの少し増やす／揺れ幅を微増
* バナー・強制ダイアログは出さない

### 10.3 通知

* MVPは通知ゼロを基本（背景で表現）
* 将来：ゲリラ開催通知を任意で提供（設定でON/OFF）

---

## 11. 認証・アカウント連携（Guest / Apple / Google / 将来OAuth）

本章は、**Guest開始**と**他端末同期**、さらに将来の外部連携（Notion / Git系）まで見据えた認証方針を定義する。

### 11.1 認証ステート

* Guest（匿名）

  * 初回起動は基本Guestで開始（入力ゼロ）
  * 端末内データで継続可能
* Authenticated（永続）

  * Apple / Google でログイン
  * 他端末で同一アカウントにログインすると同期

※MVPは Firebase Authentication を前提とする（匿名→永続への昇格が容易）。

### 11.2 Guest開始と“昇格”

* Guestは Firebase Auth の匿名ユーザーを利用する
* 後から Apple / Google を追加する際は「新規サインイン」ではなく、匿名アカウントに**資格情報をリンク**して昇格する

  * これにより、Guest期間に作成したタスク・風船データを引き継げる

参考：匿名認証と、匿名→永続アカウントへのリンク。 (Firebase公式) ([firebase.google.com](https://firebase.google.com/docs/auth/flutter/anonymous-auth?utm_source=chatgpt.com))

### 11.3 Apple / Google の“複数プロバイダログイン”

* 1つのユーザーに対し、Apple と Google の両方をリンク可能にする
* 将来、ユーザーは「Appleで入ったけど、Googleでも入れる」を実現できる
* リンク後は同一ユーザーIDとして扱う

参考：Firebaseのアカウントリンク（複数プロバイダ）。 ([firebase.google.com](https://firebase.google.com/docs/auth/ios/account-linking?utm_source=chatgpt.com))

#### 11.3.1 例外（既に別アカウントにリンク済み）

* linkに失敗するケース（例：そのGoogle/Appleが既に別ユーザーに紐付く）
* この場合は「アカウント統合（マージ）」が必要

  * MVPでは「既に使用中のため統合が必要」表示＋サポート導線でもよい
  * 将来は自動マージ（データ移行）を実装

参考：linkWithCredentialの失敗時にマージを検討する旨（一般的注意）。 ([stackoverflow.com](https://stackoverflow.com/questions/39850033/how-to-link-multiple-auth-providers-to-an-firebase-account-on-android?utm_source=chatgpt.com))

### 11.4 他端末同期

* 同一永続アカウント（Apple/Google）でログインした端末は同じユーザーとして扱う
* Guestのままでは端末間同期はしない（端末依存）
* Guest→永続に昇格した時点で同期対象となる

### 11.5 外部連携（将来）：Notion / Git系

外部サービス連携は「ログイン（認証）」と「API権限（OAuth）」を分離する。

* アプリへのログイン：Firebase Auth（Apple/Google）
* 外部連携：各サービスのOAuth 2.0（Notion, GitHub など）

  * サーバ側でアクセストークン/リフレッシュトークンを安全に保管
  * 端末に長期トークンを保持しない

#### 11.5.1 Notion

* OAuthフローで `access_token` と `refresh_token` を取得
* `refresh_token` でアクセストークンを更新できる

参考：Notion OAuth（アクセストークン/リフレッシュトークン）と更新。 ([developers.notion.com](https://developers.notion.com/docs/authorization?utm_source=chatgpt.com))

#### 11.5.2 GitHub（Gitタスク連携）

* 連携方式は「OAuth App」または「GitHub App」を選択

  * 将来の権限管理・配布を考えると GitHub App が扱いやすい
* ユーザーアクセストークンは期限があり、refreshが必要になり得る

参考：GitHub Appのユーザートークン生成・更新。 ([docs.github.com](https://docs.github.com/en/enterprise-server%403.15/apps/creating-github-apps/authenticating-with-a-github-app/generating-a-user-access-token-for-a-github-app?utm_source=chatgpt.com))

### 11.6 設定画面導線（遷移最小）

設定画面に「アカウント」セクションを追加し、1画面内で完結させる。

* アカウント

  * 現在の状態：Guest / Apple連携済 / Google連携済
  * [Appleで連携] [Googleで連携]
  * （将来）[Notion連携] [GitHub連携]

外部連携の認可画面はWebView/外部ブラウザで行い、戻り後に状態を反映する。

---

## 12. 権限・プライバシー

### 11.1 位置情報（GPS）

* 目的：国設定の補助提案のみ
* 保存：国コードのみ（緯度経度は保存しない）
* 取得：ユーザーが「現在地から提案」を押した時だけ（Foreground）
* 未許可でも手動で国設定できる

### 11.2 データの最小化

* 風船背景に個人識別情報は出さない
* タスク完了数などの統計をユーザー同士で比較できない設計

---

## 12. サブスク（Free / Pro）

### 12.1 Free

* 風船作成：上限あり（別章の仕様に従う）
* 公開：上限あり
* 選択：1
* 色：固定12色から単色
* タグ：12個プリセット

### 12.2 Pro（将来）

* 選択：複数（束＋タグで表現）
* 色：複数色・カスタム（詳細別途）
* タグ：追加セット解放（例：12→24など）

※体験の優劣にならないよう、特典は見た目と上限緩和中心とする。

---

## 13. ゲリラ風船仕様（詳細）

### 13.1 自動生成

* 1日あたり 3〜5 回
* 1回あたり 1〜3 時間
* UTC日付単位で生成（Tasbal Day）
* 重複回避（最低間隔 30〜60分推奨）

### 13.2 管理者作成（外部発火）

* 管理者が任意の開始・終了でイベントを作成できる
* 優先度で自動生成より優先可能

### 13.3 表示

* 流動グループとして出入りする
* 背景でのみ表現（数値・通知は最小）
* 開催中のみ存在感を微増してもよい（色・揺れなど）

---

## 14. オフライン・同期（MVP方針）

### 14.1 オフライン基本

* タスクは端末ローカルで作成・更新できる
* ネット復帰時に同期

### 14.2 競合方針（シンプル）

* 同一タスクの編集競合は「更新日時が新しいものを採用」
* タスク完了は冪等（同一完了の二重加算を防ぐ）

---

## 15. エラー・ローディング

* ローディングは最小（静かなスケルトン）
* 通信失敗時も背景は動き続ける
* エラーはトースト1行程度（連続表示は抑制）

---

## 16. アクセシビリティ・端末配慮

* Reduce Motion（動きの軽減）に対応

  * 風船数を減らす／揺れ幅を下げる／割れ演出を最小に
* 省電力モード時はLow品質へ（風船10、ブラーOFF）
* 色覚多様性：色だけで意味が確定しない設計（タグも意味は持たない）

---

## 17. 未決定・保留事項（別途検討）

* Proの色カスタム詳細（複数色、グラデ、パターン等）
* 通知の導入範囲（ゲリラ通知など）
* 管理者コンソールの具体UI
* 進捗加算ロジックの細部（風船種別ごとの加算比率など）

---

## 18. 確定事項まとめ

* 3タブ構成（タスク / 風船 / 設定）
* タスク状態（通常/完了/非表示/期限切れ）
* 背景風船：Pinned（常時）/ Drifting（流動）の2グループ
* 常時表示：global / location / breathing / 選択中user
* 深呼吸風船は特別操作なし（他と同じ扱い）
* 色：Freeは固定12色、タグ：12個プリセット
* 選択：Freeは1、Proは複数（束＋タグ）
* 位置情報は国提案の補助のみ（国コードのみ保存）
* Tasbal Day：UTC日付
* ゲリラ：自動生成＋管理者作成の両対応

---

## 19. 次工程

* DBスキーマ（DDL）を別ファイルで確定（`tasbal_db_schema.md`）
* API設計
* 背景風船エンジン擬似コード→実装
* MVP実装チェックリスト
